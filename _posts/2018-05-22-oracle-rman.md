---
layout: post
title: Oracle RMAN备份与恢复
categories: [Oracle]
tags: RMAN
---

> RMAN（Recovery Manager，恢复管理器）是从 Oracle 8开始提供的用于备份和恢复的强大工具，Oracle通过对RMAN的持续升级更新使得该工具越来越强大。

RMAN 有 3 种不同的用户接口： COMMAND LINE 方式、GUI方式(集成在OEM中的备份管理器)和API方式(用于集成到第三方的备份软件中)。使用RMAN不但可以完成Oracle数据库备份和恢复的各种任务，还具备相当全面的报表功能。

和用户管理的备份方式相比，使用 RMAN 具有以下一系列的优点。

- 备份执行期间不需要人工介入，从而减少了误操作的可能。
- 可以有效的将备份和恢复结合起来。
- 支持除逻辑备份以外的所有备份类型，包括完全备份、增量备份、表空间备份、数据文件备份、控制文件备份以及归档日志文件备份等。
- 可以通过 RMAN 识别 corrupted block，并可以通过 RMAN 进行块级恢复。
- 方便的实现定期（定时）备份。
- 自动生成备份日志。
- RMAN 的备份脚本和 OS 无关，方便移植。
- 强大的报表功能可以方便地获悉备份的可用性。
- RMAN 备份可以跳过未使用过的数据块，从而缩减备份集大小。当使用系统工具拷贝Oracle文件进行备份时，是无法区分Oracle数据块是否使用的，RMAN则可以根据高水位标记（High Water Mark-HWM）来识别从未使用过的数据块，在备份时这些数据块可以被跳过。
- 从 Oracle 10g 开始， Oracle 可以对备份集进行压缩，从而缩减备份空间的占用。备份压缩会消耗额外的CPU资源，但是可以节省存储，具体应该根据系统情况进行考虑。
- 从 Oracle10g 开始，通过 RMAN可以实现跨平台的表空间迁移。

使用 RMAN 进行备份，还需要了解一个重要概念：恢复目录。

RMAN 在进行备份时，需要将备份信息存储起来，这些信息将用来进行恢复，如果丢失了这些信息，恢复将会变得极其困难和复杂。

缺省的 RMAN 将这些信息存储在控制文件中，那么此时控制文件的安全就变得极为重要，对于重要的数据库，使用控制文件进行信息存储是不够稳妥的；Oracle也支持将RMAN的备份信息存储在目录数据库中(CatalogDatabase)，目录数据库可以使用一个独立的数据库，也可以使用现有的数据库中的一个表空间，一个目录数据库可以备份多个数据库，但是注意，恢复目录同样需要进行备份，通常使用逻辑备份即可。

## 1. RMAN 的备份保留策略

使用 RMAN 可以对备份集进行管理，其中的一个重要特性是备份保留策略的设置，备份保留策略是为满足备份需求而设置的备份保留原则。

备份保留策略可以基于冗余（Redundancy）或者基于恢复窗口（Recovery Window）。对于基于冗余的策略，可以定义一个数字n用于标示RMAN为每个文件保留至少n个不同的备份；在基于恢复窗口的保留策略中，需要定义一个时间长度(例如，一周或一个月)，RMAN会保留足够的备份，以便在定义的时间长度内可以进行基于任何时间点的恢复。

当备份不再需要时会被标记为废弃（obsolete），但是废弃的备份不会自动删除，只是在RMAN目录中标记为丢弃，其状态依旧为available，要查看标记为丢弃的备份可以使用report obsolete命令，只有使用delete obsolete才会真正删除丢弃的备份。

通过在 RMAN 中执行 show all 命令可以看到很多参数配置，其中第一项就是冗余策略设置：