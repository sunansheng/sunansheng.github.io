---
layout: post
title: Oracle SCN 与 Checkpoint
categories: [Oracle]
tags: SCN
---

## 1. SCN 

Oracle数据库在内部通过SCN(Systems Change Numbers)和检查点来保证数据库的一致性、可恢复性等重要属性。

SCN就是通常所说的系统改变号，是数据库中非常重要的一个数据结构，用以标识数据库在某个确切时刻提交的版本。在事务提交时，它被赋予一个唯一的标示事务的SCN。SCN同时被作为Oracle数据库的内部时钟机制，可以被看作逻辑时钟，每个数据库都有一个全局的SCN生成器。

作为数据库内部的逻辑时钟，数据库事务依SCN而排序，Oracle也依据SCN来实现一致性读(Read Consistency)等重要数据库功能，另外对于分布式事务(Distributed Transactions)，SCN也极为重要。SCN在数据库中是唯一的，并随时间而增加，但是可能并不连贯。除非重建数据库，SCN的值永远不会被重置为0。

SCN在数据库中是无处不在的，常见的事务表、控制文件、数据文件头、日志文件、数据块头等都记录有SCN值。

## 2. SCN 的获取方式

从Oracle 10g开始,在v$database视图中增加了current_scn字段，通过查询该字段可以获得数据库的当前SCN值：

	SQL> select current_scn from v$database;

	CURRENT_SCN
	-----------
	60519050093
	
## 3. SCN 的进一步说明

系统当前SCN并不是在任何的数据库操作发生时都会改变，**SCN通常在事务提交或回滚时改变**，在控制文件、数据文件头、数据块、日志文件头中都有SCN，但其作用各不相同。

### 3.1 数据文件头

数据文件头中包含了该数据文件的 Checkpoint SCN ，表示该数据文件最近一次执行检查点操作时的 SCN 。

### 3.2 日志文件头

日志文件头中包含了 Low SCN和Next SCN。 

这两个SCN标示该日志文件包含有介于Low SCN到Next SCN的重做信息，对于Current的日志文件(当前正在被使用的Redo Logfile)，其最终SCN不可知，所以Next SCN被置为无穷大，也就是ffffffff。

来看一下日志文件的情况： 

	SQL> select l.STATUS,l.FIRST_CHANGE#,l.NEXT_CHANGE# from v$log l;

	STATUS           FIRST_CHANGE# NEXT_CHANGE#
	---------------- ------------- ------------
	CURRENT          6051905004905 281474976710655
	INACTIVE         6051904998000 6051905001479
	INACTIVE         6051905001479 6051905004905
	
Oracle在进行恢复时就需要根据低SCN和高SCN来确定需要的恢复信息位于哪一个日志或归档文件中。

## 4. 检查点

检查点是一个数据库事件，它存在的根本意义在于**减少崩溃恢复(Crash Recovery)时间**。检查点事件由CKPT后台进程触发，当检查点发生时，CKPT进程会负责通知DBWR进程将脏数据(Dirty Buffer)写出到数据文件上。CKPT进程的另外一个职责是负责更新数据文件头及控制文件上的检查点信息。

### 4.1 检查点（C heckpoint）的工作原理 

**在Oracle数据库中，当进行数据修改时，需要首先将数据读入内存中(Buffer Cache)，修改数据的同时，Oracle会记录重做(Redo)信息用于恢复。因为有了重做信息的存在，Oracle不需要在事务提交时(Commit)立即将变化的数据写回磁盘(立即写的效率会很低)，**重做的存在也正是为了在数据库崩溃之后，数据可以恢复。
 
最常见的情况，数据库可能因为断电而Crash，那么内存中修改过的、尚未写入数据文件的数据将会丢失。在下一次数据库启动之后，Oracle可以通过重做(Redo)日志进行事务重演(也就是进行前滚)，将数据库恢复到崩溃之前的状态，然后数据库可以打开提供使用，之后Oracle可以将未提交的事务进行回滚。
 
在这个启动过程中，通常大家最关心的是数据库要经历多久才能打开。也就是需要读取多少重做日志才能完成前滚。当然我们希望这个时间越短越好，Oracle也正是通过各种手段在不断优化这个过程，缩短恢复时间。

**检查点的存在就是为了缩短这个恢复时间。**当检查点发生时(此时的SCN被称为Checkpoint SCN)Oracle会通知DBWR进程，把修改过的数据，也就是此Checkpoint SCN之前的脏数据(Dirty Data)从Buffer Cache写入磁盘，当写入完成之后，CKPT进程则会相应更新控制文件和数据文件头，记录检查点信息，标识变更。

**在检查点完成之后，此检查点之前修改过的数据都已经写回磁盘，**重做日志文件中的相应重做记录对于崩溃/实例恢复不再有用。 

检查点的频度对于数据库的恢复时间具有极大的影响，如果检查点的频率高，那么恢复时需要应用的重做日志就相对得少，恢复时间就可以缩短。然而，需要注意的是，数据库内部操作的相关性极强，过于频繁的检查点同样会带来性能问题，尤其是更新频繁的数据库。所以数据库的优化是一个系统工程，不能草率。